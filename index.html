<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Merit Lottery</title>

<style>
:root{
  --fish:#E358F8;
  --tofu:#FBD297;
  --roach:#5164A2;
  --water:#43ECFF;
  --rice:#F858B8;
  --bg:#000;
}
*{box-sizing:border-box}
body{
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--bg);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:#fff;
  overflow:hidden;
}

.wrap{display:flex;flex-direction:column;align-items:center;gap:18px}
.stage{position:relative;width:min(520px,92vw);aspect-ratio:1/1}
canvas{
  width:100%;height:100%;
  border-radius:50%;
  background:#111;
  box-shadow:
    0 0 0 10px rgba(255,255,255,0.08),
    0 20px 60px rgba(0,0,0,0.8),
    inset 0 0 0 10px rgba(0,0,0,0.6);
}
.pointer{
  position:absolute;top:-6px;left:50%;
  transform:translateX(-50%);
  width:0;height:0;
  border-left:18px solid transparent;
  border-right:18px solid transparent;
  border-bottom:36px solid #fff;
  filter: drop-shadow(0 10px 12px rgba(0,0,0,0.7));
}

/* center */
.center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
.hub{
  width:120px;height:120px;border-radius:50%;
  background: radial-gradient(circle at 30% 30%,
    rgba(255,255,255,.9),
    rgba(255,255,255,.2) 55%,
    rgba(0,0,0,.82));
  display:grid;place-items:center;
  box-shadow:0 0 22px rgba(227,88,248,.35);
  transition: box-shadow .15s ease;
}
.hub span{
  font-weight:900;font-size:13px;letter-spacing:.14em;line-height:1.2;text-align:center;
  animation: neon 2.6s ease-in-out infinite;
}
@keyframes neon{
  0%,100%{ text-shadow:0 0 6px var(--fish),0 0 16px var(--fish); opacity:0.98; }
  50%{ text-shadow:0 0 2px var(--fish); opacity:0.90; }
}

/* buttons */
button{
  border:0;border-radius:14px;padding:12px 18px;
  font-weight:800;letter-spacing:.08em;cursor:pointer;
  box-shadow: 0 10px 24px rgba(0,0,0,0.55);
}
.btnbar{display:flex;gap:12px}

/* modal */
.modal{
  position:fixed;inset:0;
  display:none;place-items:center;
  background:rgba(0,0,0,.7);
  backdrop-filter: blur(4px);
  z-index:20;
}
.modal.show{display:grid}
.card{
  background:#111;
  padding:18px;border-radius:22px;
  width:min(520px,94vw);
  box-shadow:0 30px 80px rgba(0,0,0,.8);
  border:1px solid rgba(255,255,255,0.10);
  animation:pop .18s ease forwards;
}
@keyframes pop{
  from{transform:scale(.94); opacity:0.5}
  to{transform:scale(1); opacity:1}
}
.result{
  display:flex;justify-content:space-between;
  margin:12px 0;padding:12px;border-radius:16px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,0.08);
}
.choices{display:flex;justify-content:flex-end;gap:10px}
.yes{background:linear-gradient(135deg,var(--water),var(--fish))}
.no{background:linear-gradient(135deg,var(--roach),#000);color:#fff}

/* JACKPOT hub mode */
.jackpot-hub{
  box-shadow:
    0 0 18px rgba(227,88,248,.60),
    0 0 42px rgba(67,236,255,.35),
    0 0 90px rgba(248,88,184,.25);
}
.jackpot-text{ animation: jackpotNeon .08s infinite alternate; }
@keyframes jackpotNeon{
  from{
    text-shadow:
      0 0 6px var(--fish),
      0 0 16px var(--fish),
      0 0 28px var(--water),
      0 0 44px var(--rice);
    transform: translate(0,0) rotate(-0.3deg);
    opacity:1;
  }
  to{
    text-shadow:
      0 0 10px #fff,
      0 0 22px var(--fish),
      0 0 40px var(--water),
      0 0 64px var(--rice);
    transform: translate(1px,-1px) rotate(0.3deg);
    opacity:0.96;
  }
}

/* full-screen jackpot overlay */
.fx{
  position:fixed;inset:-40%;
  z-index:10;pointer-events:none;
  display:none;mix-blend-mode: screen;
  background:
    radial-gradient(circle at 20% 30%, rgba(227,88,248,.38), rgba(0,0,0,0) 45%),
    radial-gradient(circle at 70% 20%, rgba(67,236,255,.30), rgba(0,0,0,0) 48%),
    radial-gradient(circle at 60% 80%, rgba(248,88,184,.24), rgba(0,0,0,0) 52%),
    radial-gradient(circle at 30% 75%, rgba(251,210,151,.20), rgba(0,0,0,0) 55%);
  animation: fxPulse .50s ease-in-out infinite alternate;
}
.fx.show{display:block;}
@keyframes fxPulse{
  from{ transform: rotate(0deg) scale(1); opacity:0.55; filter: blur(0px); }
  to{ transform: rotate(10deg) scale(1.07); opacity:0.95; filter: blur(1.6px); }
}

/* particles */
.particles{
  position:fixed;inset:0;
  pointer-events:none;z-index:15;
  display:none;
}
.particles.show{display:block;}
.p{
  position:absolute;top:-20px;left:0;
  width:10px;height:14px;border-radius:3px;
  opacity:0.95;
  animation: fall 1.15s linear forwards;
  will-change: transform;
}
.star{
  width:12px;height:12px;border-radius:2px;
  clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
  animation: fallStar 1.25s ease-out forwards;
}
@keyframes fall{
  to{ transform: translateY(calc(100vh + 70px)) rotate(720deg); opacity:0.9; }
}
@keyframes fallStar{
  to{ transform: translateY(calc(100vh + 90px)) rotate(980deg) scale(0.9); opacity:0.85; }
}

/* center impact burst */
.burst{
  position:fixed;left:50%;top:50%;
  width:16px;height:16px;border-radius:50%;
  transform: translate(-50%,-50%);
  pointer-events:none;z-index:16;
  display:none;
  box-shadow:
    0 0 0 0 rgba(227,88,248,.0),
    0 0 0 0 rgba(67,236,255,.0);
}
.burst.show{
  display:block;
  animation: burstPop .55s ease-out forwards;
}
@keyframes burstPop{
  0%{
    box-shadow:
      0 0 0 0 rgba(227,88,248,.60),
      0 0 0 0 rgba(67,236,255,.38);
    opacity:1;
  }
  100%{
    box-shadow:
      0 0 0 230px rgba(227,88,248,0),
      0 0 0 400px rgba(67,236,255,0);
    opacity:0;
  }
}
</style>
</head>

<body>
<div class="fx" id="fx"></div>
<div class="particles" id="particles"></div>
<div class="burst" id="burst"></div>

<div class="wrap">
  <div class="stage">
    <div class="pointer"></div>
    <canvas id="wheel" width="900" height="900"></canvas>
    <div class="center">
      <div class="hub" id="hub">
        <span id="hubText">MERIT<br>LOTTERY</span>
      </div>
    </div>
  </div>
  <div class="btnbar">
    <button id="spinBtn">SPIN</button>
  </div>
</div>

<div class="modal" id="modal">
  <div class="card">
    <h2 id="title">Do you accept?</h2>
    <div class="result">
      <strong>RESULT</strong>
      <span id="result"></span>
    </div>
    <div class="choices">
      <button class="yes" id="yes">YES</button>
      <button class="no" id="no">NO</button>
    </div>
  </div>
</div>

<script>
const items = [
  {name:"Sacred Fake Fish", color:"#E358F8", jackpot:true},
  {name:"Fish Tofu",       color:"#FBD297"},
  {name:"Cockroach",       color:"#5164A2"},
  {name:"Water Bottle",    color:"#43ECFF"},
  {name:"Rice",            color:"#F858B8"}
];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const cx = 450, cy = 450, r = 400;
const n = items.length;
const slice = Math.PI * 2 / n;

let angle = -Math.PI/2;
let spinning = false;

const modal = document.getElementById("modal");
const titleEl = document.getElementById("title");
const resultEl = document.getElementById("result");
const hub = document.getElementById("hub");
const hubText = document.getElementById("hubText");

const fx = document.getElementById("fx");
const particles = document.getElementById("particles");
const burst = document.getElementById("burst");

// ===== Spin behaviour you asked for =====
// Constant angular speed, random stop time.
const ANGULAR_SPEED = Math.PI * 10; // rad/s  (调大更快：12~16 也行)
const CRUISE_MIN_MS = 650;          // 匀速持续最短
const CRUISE_MAX_MS = 1650;         // 匀速持续最长
const BRAKE_MIN_MS  = 200;          // 刹车段最短
const BRAKE_MAX_MS  = 360;          // 刹车段最长

function draw(){
  ctx.clearRect(0,0,900,900);

  for(let i=0;i<n;i++){
    const it = items[i];
    const a0 = angle + i * slice;
    const a1 = a0 + slice;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,a0,a1);
    ctx.fillStyle = it.color;
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,.62)";
    ctx.lineWidth = 6;
    ctx.stroke();

    const mid = (a0+a1)/2;
    ctx.save();
    ctx.translate(cx + Math.cos(mid)*260, cy + Math.sin(mid)*260);
    ctx.rotate(mid + Math.PI/2);
    ctx.font = "900 30px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.lineWidth = 10;
    ctx.strokeStyle = "rgba(0,0,0,.55)";
    const txt = it.name.toUpperCase();
    ctx.strokeText(txt,0,0);
    ctx.fillStyle = "#fff";
    ctx.fillText(txt,0,0);
    ctx.restore();
  }

  // inner ring
  ctx.beginPath();
  ctx.arc(cx,cy, r*0.22, 0, Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,.55)";
  ctx.fill();
  ctx.strokeStyle="rgba(255,255,255,.14)";
  ctx.lineWidth=10;
  ctx.stroke();
}

draw();

function mod2pi(x){
  const m = Math.PI*2;
  return ((x % m) + m) % m;
}

// pointer is at -90deg
function indexAtPointer(){
  const pointerAngle = -Math.PI/2;
  let a = pointerAngle - angle;
  a = mod2pi(a);
  return Math.floor(a / slice) % n;
}

function clearJackpotFX(){
  fx.classList.remove("show");
  particles.classList.remove("show");
  particles.innerHTML = "";
  burst.classList.remove("show");
  hub.classList.remove("jackpot-hub");
  hubText.classList.remove("jackpot-text");
}

function launchParticles(){
  particles.innerHTML = "";
  particles.classList.add("show");

  const colors = [items[0].color, items[3].color, items[4].color, items[1].color, "#ffffff"];
  const confettiCount = 100;
  const starCount = 30;

  for(let i=0;i<confettiCount;i++){
    const el = document.createElement("div");
    el.className = "p";
    const size = 8 + Math.random()*10;
    el.style.width = size + "px";
    el.style.height = (size*1.25) + "px";
    el.style.left = (Math.random()*100) + "vw";
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.borderRadius = (Math.random()<0.35 ? "999px":"3px");
    el.style.animationDelay = (Math.random()*0.18) + "s";
    el.style.transform = `translateY(-30px) rotate(${Math.random()*360}deg)`;
    particles.appendChild(el);
  }

  for(let i=0;i<starCount;i++){
    const el = document.createElement("div");
    el.className = "p star";
    const size = 10 + Math.random()*12;
    el.style.width = size + "px";
    el.style.height = size + "px";
    el.style.left = (Math.random()*100) + "vw";
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.animationDelay = (Math.random()*0.22) + "s";
    particles.appendChild(el);
  }

  setTimeout(()=>{
    particles.classList.remove("show");
    particles.innerHTML = "";
  }, 1500);
}

function jackpotFX(){
  fx.classList.add("show");
  hub.classList.add("jackpot-hub");
  hubText.classList.add("jackpot-text");

  burst.classList.remove("show");
  void burst.offsetWidth;
  burst.classList.add("show");

  launchParticles();
  setTimeout(()=>fx.classList.remove("show"), 950);
}

function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

document.getElementById("spinBtn").onclick = () => {
  if (spinning) return;
  spinning = true;
  clearJackpotFX();

  // Choose the final category now (so it is deterministic),
  // but the stop time is random, and the cruise speed is constant.
  const chosenIdx = Math.floor(Math.random() * n);

  const cruiseMs = CRUISE_MIN_MS + Math.random() * (CRUISE_MAX_MS - CRUISE_MIN_MS);
  const brakeMs  = BRAKE_MIN_MS  + Math.random() * (BRAKE_MAX_MS  - BRAKE_MIN_MS);

  const pointerAngle = -Math.PI/2;
  const targetCenter = chosenIdx * slice + slice/2;
  const desiredBase  = pointerAngle - targetCenter;  // angle ≡ desiredBase (mod 2π)

  let phase = "cruise";
  let tCruiseStart = null;
  let tBrakeStart = null;

  let lastT = null;
  let startAngle = angle;
  let finalAngle = angle;

  function frame(t){
    if (lastT === null) lastT = t;

    const dt = (t - lastT) / 1000; // seconds
    lastT = t;

    if (phase === "cruise"){
      if (tCruiseStart === null) tCruiseStart = t;

      // constant speed
      angle += ANGULAR_SPEED * dt;
      draw();

      if (t - tCruiseStart >= cruiseMs){
        // enter brake: compute a finalAngle ahead of current angle
        // so the wheel continues the same direction and lands precisely.
        const m = Math.PI * 2;

        // Normalize current angle relative to desiredBase
        // We want finalAngle = desiredBase + k*m such that finalAngle >= angle + small_margin
        const k = Math.ceil((angle - desiredBase) / m);
        finalAngle = desiredBase + k * m;

        // Make sure there's enough remaining rotation to look like a real stop (add an extra full turn sometimes)
        // This does NOT affect "random stop time" because we only brake for brakeMs.
        const extraTurns = (Math.random() < 0.55) ? 1 : 0;
        finalAngle += extraTurns * m;

        startAngle = angle;
        phase = "brake";
        tBrakeStart = t;
      }

      requestAnimationFrame(frame);
      return;
    }

    if (phase === "brake"){
      const p = Math.min(1, (t - tBrakeStart) / brakeMs);
      const e = easeOutCubic(p); // short brake, not a long tail
      angle = startAngle + (finalAngle - startAngle) * e;
      draw();

      if (p < 1){
        requestAnimationFrame(frame);
      } else {
        spinning = false;

        const it = items[chosenIdx];
        resultEl.textContent = it.name;

        if (it.jackpot){
          titleEl.textContent = "JACKPOT — A SACRED MERIT HAS BEEN GRANTED";
          jackpotFX();
        } else {
          titleEl.textContent = "Do you accept?";
        }
        modal.classList.add("show");
      }
    }
  }

  requestAnimationFrame(frame);
};

// close modal
function closeModal(){
  modal.classList.remove("show");
  clearJackpotFX();
}
document.getElementById("yes").onclick = closeModal;
document.getElementById("no").onclick  = closeModal;
modal.addEventListener("click",(e)=>{ if(e.target === modal) closeModal(); });
</script>

</body>
</html>
